CREATE OR REPLACE PROCEDURE GETUMISURAASSENZA (PROG IN NUMBER, D IN DATE, CAUSALE IN VARCHAR2, UM OUT VARCHAR2) AS
  CODRAG VARCHAR2(5);
  ANNOSOLARE VARCHAR2(1);
  PROASS VARCHAR2(5);
BEGIN
  UM:='';
  SELECT T260.CODICE,T260.CONTASOLARE
    INTO CODRAG,ANNOSOLARE
    FROM T260_RAGGRASSENZE T260,T265_CAUASSENZE T265
   WHERE T265.CODICE = CAUSALE
     AND T260.CODICE = T265.CODRAGGR;
   IF ANNOSOLARE = 'S' THEN
     BEGIN
       SELECT UMISURA
         INTO UM
         FROM T263_PROFASSIND
        WHERE PROGRESSIVO = PROG
          AND D BETWEEN DAL and AL
          AND CODRAGGR = CODRAG;
     EXCEPTION
       WHEN NO_DATA_FOUND THEN
         SELECT PASSENZE
           INTO PROASS
           FROM T430_STORICO
          WHERE PROGRESSIVO = PROG
            AND DATADECORRENZA <= D
            AND DATAFINE >= D;

         SELECT UMISURA
           INTO UM
           FROM T262_PROFASSANN
          WHERE CODPROFILO = PROASS
            AND ANNO = TO_NUMBER(TO_CHAR(D,'YYYY'))
            AND CODRAGGR = CODRAG;
     END;
   ELSE
     SELECT UMISURA
       INTO UM
       FROM T265_CAUASSENZE
      WHERE CODICE = CAUSALE;
   END IF;
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    UM:='';
END;
/
