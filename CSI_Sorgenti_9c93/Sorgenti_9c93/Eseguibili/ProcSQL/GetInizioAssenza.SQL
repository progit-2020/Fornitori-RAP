CREATE OR REPLACE PROCEDURE GETINIZIOASSENZA (PROG IN NUMBER, D IN DATE, CAUS IN VARCHAR2, DI OUT DATE) AS
  CURSORE_DINAMICO INTEGER;
  D2 DATE;
  CICLO BOOLEAN;
  CAUS_COLL VARCHAR2(1500);
  CAUS_COLL2 VARCHAR2(1500);
  ESPRESSIONE VARCHAR2(2000);
  CURS INTEGER;
  I INTEGER;
BEGIN
  D2:=D;
  CICLO:=TRUE;
  BEGIN
    SELECT CODCAU1 INTO CAUS_COLL FROM T265_CAUASSENZE WHERE CODICE = CAUS;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      CAUS_COLL:=NULL;
  END;
  IF CAUS_COLL IS NULL THEN
    CAUS_COLL:=CAUS;
  ELSE
    CAUS_COLL:=CAUS || ',' || CAUS_COLL;
  END IF;
  BEGIN
    SELECT CODCAU2 INTO CAUS_COLL2 FROM T265_CAUASSENZE WHERE CODICE = CAUS;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      CAUS_COLL2:=NULL;
  END;
  IF CAUS_COLL2 IS NOT NULL THEN
    CAUS_COLL:=CAUS_COLL || ',' || CAUS_COLL2;
  END IF;
  CAUS_COLL:='''' || REPLACE(CAUS_COLL,',',''',''') || '''';
  ESPRESSIONE:='SELECT /*+ INDEX(T040_GIUSTIFICATIVI T040_PK)*/ DATA FROM T040_GIUSTIFICATIVI WHERE PROGRESSIVO = ' || PROG || ' AND DATA = :D AND CAUSALE IN (' || CAUS_COLL || ')';
  CURSORE_DINAMICO:=DBMS_SQL.OPEN_CURSOR;
  DBMS_SQL.PARSE(CURSORE_DINAMICO,ESPRESSIONE,DBMS_SQL.NATIVE);
  DBMS_SQL.DEFINE_COLUMN(CURSORE_DINAMICO,1,D2);
  WHILE CICLO LOOP
    IF CICLO THEN
      SELECT COUNT(*) INTO I FROM T031_DATACARTELLINO WHERE PROGRESSIVO = PROG AND DATA = D2 AND TIPO = '1';
      IF I > 0 THEN
        CICLO:=FALSE;
        DI:=D2;
      END IF;
    END IF;
    D2:=D2 - 1;
    BEGIN
      DBMS_SQL.BIND_VARIABLE(CURSORE_DINAMICO, 'D', D2);
      CURS:=DBMS_SQL.EXECUTE(CURSORE_DINAMICO);
      IF DBMS_SQL.FETCH_ROWS(CURSORE_DINAMICO) = 0 THEN
        CICLO:=FALSE;
        DI:=D2 + 1;
      END IF;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        CICLO:=FALSE;
        DI:=D2 + 1;
    END;
  END LOOP;
  DBMS_SQL.CLOSE_CURSOR(CURSORE_DINAMICO);
END;
/