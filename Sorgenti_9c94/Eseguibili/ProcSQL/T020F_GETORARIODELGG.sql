create or replace function T020F_GETORARIODELGG(P_PROGRESSIVO in integer, P_DATA in date) return varchar2 as
  result varchar2(5);
  wPORARIO varchar2(5);
begin
  select max(ORARIO) into result 
  from T080_PIANIFORARI
  where PROGRESSIVO = P_PROGRESSIVO
  and DATA = P_DATA;
  
  if result is null then
    select PORARIO into wPORARIO 
    from T430_STORICO 
    where PROGRESSIVO = P_PROGRESSIVO
    and P_DATA between DATADECORRENZA and DATAFINE;
  
    select ORARIO into result from 
      (SELECT LUNEDI ORARIO FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 2 UNION
       SELECT MARTEDI FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 3 UNION
       SELECT MERCOLEDI FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 4 UNION
       SELECT GIOVEDI FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 5 UNION
       SELECT VENERDI FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 6 UNION
       SELECT SABATO FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 7 UNION
       SELECT DOMENICA FROM T221_PROFILISETTIMANA T221,T220_PROFILIORARI T220 WHERE T220.CODICE = wPORARIO AND T221.CODICE = T220.CODICE AND T221.DECORRENZA = T220.DECORRENZA AND P_DATA BETWEEN T220.DECORRENZA AND T220.DECORRENZA_FINE AND T221.PROGRESSIVO = 1 AND TO_CHAR(P_DATA,'D') = 1); 
  end if;  
  
  return result;
exception
  when others then 
    return null;  
end;  
/